<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>Cody1982</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <!--<link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
</head>

<body>
<div id="app">
    <!-- Vue app-->
    <v-app>
        <v-content>

            <a href="../index.html">Experiments</a>
            <h1>Cody1982</h1>

            <h2>Models</h2>
            <p>
            <ul>
                <li><strong>model</strong>: <a href="../../../../models/results/models/captopril_body_flat.xml">../../../../models/results/models/captopril_body_flat.xml</a></li>
            </ul>
            </p>

            <h2>Datasets</h2>
            <p>
            <ul>
                <li><strong>CAP25_captopril_blood_all</strong>: <a href="Cody1982_CAP25_captopril_blood_all.tsv">Cody1982_CAP25_captopril_blood_all.tsv</a></li>
                <li><strong>CAP25_total captopril_blood_all</strong>: <a href="Cody1982_CAP25_total captopril_blood_all.tsv">Cody1982_CAP25_total captopril_blood_all.tsv</a></li>
                <li><strong>CAP25_captopril_blood_I1</strong>: <a href="Cody1982_CAP25_captopril_blood_I1.tsv">Cody1982_CAP25_captopril_blood_I1.tsv</a></li>
                <li><strong>CAP25_captopril_blood_I2</strong>: <a href="Cody1982_CAP25_captopril_blood_I2.tsv">Cody1982_CAP25_captopril_blood_I2.tsv</a></li>
                <li><strong>CAP25_concentration_renin_I1</strong>: <a href="Cody1982_CAP25_concentration_renin_I1.tsv">Cody1982_CAP25_concentration_renin_I1.tsv</a></li>
                <li><strong>CAP25_concentration_renin_I2</strong>: <a href="Cody1982_CAP25_concentration_renin_I2.tsv">Cody1982_CAP25_concentration_renin_I2.tsv</a></li>
                <li><strong>CAP25_concentration_renin_all</strong>: <a href="Cody1982_CAP25_concentration_renin_all.tsv">Cody1982_CAP25_concentration_renin_all.tsv</a></li>
            </ul>
            </p>

            <h2>Figures</h2>
            <p>
            <ul>
                <li><strong>PK</strong>: <a href="Cody1982_PK.svg">Cody1982_PK.svg</a></li>
                <li><strong>PD</strong>: <a href="Cody1982_PD.svg">Cody1982_PD.svg</a></li>
            </ul>
            </p>

            <h3>PK</h3>
            <p>
            <table>
                <tr>
                    <td>
                        <!--<v-img src="Cody1982_PK.svg" max-width="600" width="600"></v-img>-->
                        <img src="Cody1982_PK.svg" width="600">
                    </td>
                    <!--
                    <td>
                    </td>
                    -->
                </tr>
            </table>
            </p>
            <h3>PD</h3>
            <p>
            <table>
                <tr>
                    <td>
                        <!--<v-img src="Cody1982_PD.svg" max-width="600" width="600"></v-img>-->
                        <img src="Cody1982_PD.svg" width="600">
                    </td>
                    <!--
                    <td>
                    </td>
                    -->
                </tr>
            </table>
            </p>

            <h2>Code</h2>
            <p>
                <a href="../../../../experiments/studies/cody1982.py">../../../../experiments/studies/cody1982.py</a>
            <pre>
<code class="python">"""Cody1982"""

from typing import Dict, Tuple, List, Hashable

import numpy as np
from sbmlsim.data import DataSet, load_pkdb_dataframe
from sbmlsim.fit import FitMapping, FitData
from sbmlutils.console import console

from pkdb_models.models.captopril.experiments.base_experiment import (
    CaptoprilSimulationExperiment,
)
from pkdb_models.models.captopril.experiments.metadata import Tissue, Route, Dosing, Health, Fasting, \
    CaptoprilMappingMetaData, PKPDData
from sbmlsim.plot import Axis, Figure
from sbmlsim.simulation import Timecourse, TimecourseSim

from pkdb_models.models.captopril.helpers import run_experiments


class Cody1982(CaptoprilSimulationExperiment):
    """Simulation experiment for Cody1982.

    Pharmacokinetics and the acute hemodynamic and hormonal response in patinents with
    severe chronic congestive heart failure (CHF).
    Captopril (25 mg) was administered to 12 patients with congestive heart failure (CHF).
    - overnight fasting
    - 7 patients had class 3 NYHA, 5 patients - class 4
    - in the article - sem is given only for one point, checked
    """

    route = "PO"
    dose = 25
    yids = []
    clabels = []
    element_ids = []

    ren = {
        "all": 41.04,
        "I1": 4.56,
        "I2": 159.6
    }



    elements_unique = ["total captopril", "captopril", "concentration_renin"]

    def datasets(self) -> dict[str, DataSet]:
        dsets = {}
        self.reset_state()

        for fig_id in ["Fig1", "Fig2", "TabText2"]:

            df = load_pkdb_dataframe(f"{self.sid}_{fig_id}", data_path=self.data_path)
            for label, df_label in df.groupby("label"):
                dset = DataSet.from_df(df_label, self.ureg)
                for element in self.elements_unique:
                    if element in label:
                        individual = False
                        if "_I1" in label or "_I2" in label:
                            individual = True
                        self.data_collection( element=element, label=label, individual=individual, in_blood=True)
                        dset.unit_conversion(
                            self.data_type, self.conversion_factor
                        )
                        dsets[f"{label}"] = dset
                        break
        return dsets

    def simulations(self) -> Dict[str, TimecourseSim]:
        Q_ = self.Q_
        tcsims = {}

        for group, ren_value in self.ren.items():
            tcsims[f"cap_{self.route}_{self.dose}_{group}_CHF"] = TimecourseSim(
                Timecourse(
                    start=0,
                    end=9 * 60,  # minutes
                    steps=400,
                    changes={
                        **self.default_changes(),
                        f"{self.route.upper()}DOSE_cap": Q_(self.dose, "mg"),
                        "f_cardiac_function": Q_(
                            (self.cardiac_map["Severe cardiac impairment"] * 7 + self.cardiac_map["Cardiac failure"] * 5) / 12, "dimensionless"
                        ),
                        f"ren_ref": Q_(ren_value, "pg/ml") / self.Mr.ren,
                        f"[ren]": Q_(ren_value, "pg/ml") / self.Mr.ren
                    },
                )
            )
        return tcsims

    def fit_mappings(self) -> Dict[str, FitMapping]:
        mappings = {}
        for kr, dset_id in enumerate(self.clabels):
            group = dset_id.split("_")[-1]
            mappings[
                f"fm_cap{self.route}{self.dose}_{self.element_ids[kr]}_plasma_acute_fasting_{group}_CHF"
            ] = FitMapping(
                self,
                reference=FitData(
                    self,
                    dataset=dset_id,
                    xid="time",
                    yid="mean" if group == "all" else "value",
                    yid_sd="mean_sd" if group == "all" else None,
                    count="count",
                ),
                observable=FitData(
                    self,
                    task=f"task_cap_{self.route}_{self.dose}_{group}_CHF",
                    xid="time",
                    yid=self.yids[kr],
                ),
                metadata=CaptoprilMappingMetaData(
                    tissue=Tissue.PLASMA,
                    route=Route.PO,
                    dosing=Dosing.SINGLE,
                    health=Health.HEART_FAILURE,
                    fasting=Fasting.FASTING,
                    data=PKPDData.PK if "captopril" in dset_id else PKPDData.PD,
                ),
            )
        # console.print(mappings)
        return mappings

    def figures(self) -> Dict[str, Figure]:
        figures = {}
        figures["PK"] = self.figures_pk()
        figures["PD"] = self.figures_pd()
        return figures

    def figures_pk(self) -> Figure:

        fig = Figure(
            experiment=self,
            sid="PK",
            num_rows=1,
            num_cols=2,
            name=f"{self.__class__.__name__}",
            height=self.panel_height,
            width=self.panel_width * 2,
        )
        plots = fig.create_plots(
            xaxis=Axis(self.labels["time"], unit=self.units["time"]), legend=True
        )

        for ky, yid in enumerate(["[Cve_cap]", "[Cve_captot]"]):
            plots[ky].set_yaxis(self.labels[yid], unit=self.units[yid])
            if ky == 0:
                for group in self.ren.keys():
                    # simulation
                    plots[ky].add_data(
                        task=f"task_cap_{self.route}_{self.dose}_{group}_CHF",
                        xid="time",
                        yid=yid,
                        label=f"CHF sim {group}: {self.dose}mg PO",
                        color=self.subgroups_colors[group],
                    )
            else:
                # simulation
                plots[ky].add_data(
                    task=f"task_cap_{self.route}_{self.dose}_all_CHF",
                    xid="time",
                    yid=yid,
                    label=f"CHF sim all: {self.dose}mg PO",
                    color=self.subgroups_colors["all"],
                )

        for k, label in enumerate(self.clabels):
            if "captopril" in label:
                kp = 1 if "total captopril" in label else 0
                group = label.split("_")[-1]
                plots[kp].add_data(
                    dataset=label,
                    xid="time",
                    yid="mean" if group == "all" else "value",
                    yid_sd="mean_sd" if group == "all" else None,
                    count="count",
                    label=f"CHF exp {group}: {self.dose}mg PO",
                    color=self.subgroups_colors[group],
                    marker="s" if group == "all" else "o",
                )
        return fig

    def figures_pd(self) -> Figure:
        fig = Figure(
            experiment=self,
            sid="PD",
            num_rows=1,
            num_cols=1,
            name=f"{self.__class__.__name__}",
            height=self.panel_height,
            width=self.panel_width,
        )
        plots = fig.create_plots(
            xaxis=Axis(self.labels["time"], unit=self.units["time"]), legend=True
        )

        plots[0].set_yaxis(self.labels["[ren]"], unit=self.units["[ren]"])
        for group in self.ren.keys():
            # simulation
            plots[0].add_data(
                task=f"task_cap_{self.route}_{self.dose}_{group}_CHF",
                xid="time",
                yid="[ren]",
                label=f"CHF sim {group}: {self.dose}mg PO",
                color=self.subgroups_colors[group],
            )

        for k, label in enumerate(self.clabels):
            if "renin" in label:
                kp = 0 if "renin" in label else 1
                group = label.split("_")[-1]
                plots[kp].add_data(
                    dataset=label,
                    xid="time",
                    yid="mean" if group == "all" else "value",
                    yid_sd="mean_sd" if group == "all" else None,
                    count="count",
                    label=f"CHF exp {group}: {self.dose}mg PO",
                    color=self.subgroups_colors[group],
                    markers="s" if group == "all" else "o",
                )
        return fig

if __name__ == "__main__":
    run_experiments(Cody1982, output_dir=Cody1982.__name__)
</code>
        </pre>
            </p>

        </v-content>
    </v-app>
</div>


<!-- loading dependencies -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.6/dist/vuetify.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
    const app = new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        delimiters: ['${', '}'],
        data() {
            return {}
        }
    })
</script>


</body>
</html>